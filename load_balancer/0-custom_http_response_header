#!/usr/bin/env bash
# 0-custom_http_response_header: Add X-Served-By header to Nginx

set -euo pipefail

# require root
if [ "$EUID" -ne 0 ]; then
  echo "Please run as root: sudo $0"
  exit 1
fi

echo -e "Updating and doing some minor checks...\n"

install_pkg() {
  pkg="$1"
  if ! command -v "$pkg" >/dev/null 2>&1; then
    echo -e "Installing: $pkg"
    apt-get update -y -qq
    apt-get install -y "$pkg" -qq
    echo -e "\n"
  else
    echo -e "$pkg is already installed.\n"
  fi
}

install_pkg nginx

echo -e "\nSetting up some minor stuff.\n"

# allow nginx through firewall (if ufw exists)
if command -v ufw >/dev/null 2>&1; then
  ufw allow 'Nginx HTTP' || true
fi

# Ensure /var/www exists and give appropriate permissions
sudo mkdir -p /var/www/html /var/www/error
sudo chown -R "$SUDO_USER":"$SUDO_USER" /var/www || true
sudo chmod -R 755 /var/www

# create simple pages
echo "Hello World!" | tee /var/www/html/index.html >/dev/null
echo "Ceci n'est pas une page" | tee /var/www/html/error_404.html >/dev/null

# backup default config
cp /etc/nginx/sites-enabled/default /tmp/nginx-default.backup.$(date +%s)

# correct server config
server_config='server {
    listen 80 default_server;
    listen [::]:80 default_server;

    root /var/www/html;
    index index.html index.htm index.nginx-debian.html;

    server_name _;

    add_header X-Served-By $hostname;

    location / {
        try_files $uri $uri/ =404;
    }

    if ($request_filename ~ redirect_me) {
        rewrite ^ https://th3-gr00t.tk/ permanent;
    }

    error_page 404 /error_404.html;

    location = /error_404.html {
        internal;
    }
}'

# write the config (atomic)
echo "$server_config" | tee /etc/nginx/sites-enabled/default > /dev/null

# test nginx config before reload
if nginx -t; then
    systemctl restart nginx
    echo "Nginx restarted successfully."
else
    echo "Nginx config test failed. Check the output above."
    exit 1
fi
